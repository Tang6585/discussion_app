<?php
// db.php - Database Connection
$dsn = 'mysql:host=localhost;dbname=discussion_item;charset=utf8mb4';
$user = 'root';
$pass = '';

try {
    $pdo = new PDO($dsn, $user, $pass, [
        PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION,
    ]);
} catch (PDOException $e) {
    die('Database Connection Failed: ' . $e->getMessage());
}

// ‚úÖ Handle Subscription Before Other POST Actions
$subscriptionMessage = '';

if (isset($_POST['subscribe'])) {
    $email = trim($_POST['email'] ?? '');
    $topic = trim($_POST['topic'] ?? '');

    if ($email && $topic) {
        try {
            $stmt = $pdo->prepare("INSERT INTO subscriptions (email, topic) VALUES (?, ?)");
            $stmt->execute([$email, $topic]);
            $subscriptionMessage = "
                <div class='alert alert-success mt-3'>
                    ‚úÖ <strong>Subscribed!</strong> Confirmation for <b>$topic</b> has been saved.
                </div>";
        } catch (PDOException $e) {
            $subscriptionMessage = "
                <div class='alert alert-danger mt-3'>
                    ‚ùå Database error: " . htmlspecialchars($e->getMessage()) . "
                </div>";
        }
    } else {
        $subscriptionMessage = "
            <div class='alert alert-warning mt-3'>
                ‚ö† Please select a topic and enter a valid email address.
            </div>";
    }
}

// Handle Form Submissions
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    $action = $_POST['action'] ?? '';

    if ($action === 'new_discussion') {
        $topic = trim($_POST['topic'] ?? '');
        $statement = trim($_POST['statement'] ?? '');
        if ($topic && $statement) {
            $stmt = $pdo->prepare("INSERT INTO discussions (topic, statement) VALUES (:topic, :statement)");
            $stmt->execute([':topic' => $topic, ':statement' => $statement]);
        }
    }

    if (isset($_POST['discussion_id'])) {
        $discussionId = (int)$_POST['discussion_id'];
        if ($action === 'like') {
            $pdo->exec("UPDATE discussions SET likes = likes + 1 WHERE id = $discussionId");
        } elseif ($action === 'retweet') {
            $pdo->exec("UPDATE discussions SET retweets = retweets + 1 WHERE id = $discussionId");
        } elseif ($action === 'reply') {
            $replyText = trim($_POST['reply_text'] ?? '');
            if ($replyText) {
                $stmt = $pdo->prepare("INSERT INTO replies (discussion_id, reply_text) VALUES (:discussion_id, :reply_text)");
                $stmt->execute([':discussion_id' => $discussionId, ':reply_text' => $replyText]);
            }
        }
    }

    header("Location: " . $_SERVER['REQUEST_URI']);
    exit;
}

// Fetch Topics
$topics = $pdo->query("SELECT DISTINCT topic FROM discussions")->fetchAll(PDO::FETCH_COLUMN);

// Fetch Discussions by Topic
$selectedTopic = $_GET['topic'] ?? ($topics[0] ?? '');
$discussions = [];
if ($selectedTopic) {
    $stmt = $pdo->prepare("SELECT * FROM discussions WHERE topic = :topic ORDER BY id DESC");
    $stmt->execute([':topic' => $selectedTopic]);
    $discussions = $stmt->fetchAll(PDO::FETCH_ASSOC);
}

function fetchReplies(PDO $pdo, int $discussionId): array {
    $stmt = $pdo->prepare("SELECT reply_text FROM replies WHERE discussion_id = :discussion_id ORDER BY id DESC");
    $stmt->execute([':discussion_id' => $discussionId]);
    return $stmt->fetchAll(PDO::FETCH_COLUMN);
}
?>
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Computer Science Discussion Forum</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<style>
/* ===== General Look ===== */
body {
  background: url('fb.jpg') no-repeat center center fixed;
  background-size: cover;
  backdrop-filter: blur(3px);
  color: #FFD700 !important; /* gold text everywhere */
  font-family: 'Segoe UI', sans-serif;
}
/* Make reply text and interaction info clearer */
.reply-text,
.discussion-reply,
.like-count,
.retweet-count,
.timestamp,
.reply-button {
  color: #FFD700 !important; /* Yellow gold */
  font-weight: 600;
}

/* Ensure username and discussion topic text are readable */
.username,
.discussion-topic {
  color: #FFD700 !important;
  font-weight: bold;
}

/* Slight glow for contrast */
.reply-text,
.timestamp {
  text-shadow: 0 0 3px rgba(0,0,0,0.6);
}

/* Buttons hover effect */
.reply-button:hover {
  background-color: #FFD700 !important;
  color: #000 !important;
}


/* Remove blue boxes */
.card, section, .discussion-box, .subscribe-box {
  background: transparent !important;
  border: none !important;
  box-shadow: none !important;
}

/* Smooth gold text for everything */
p, span, a, small, label, strong, b, .nav-link, .discussion, .reply, .time, .meta-info {
  color: #FFD700 !important;
}

/* Headings and titles */
h1, h2, h3, h4, h5, h6 {
  color: #FFD700 !important;
  font-weight: bold;
}

/* Topic tabs */
.nav-pills .nav-link {
  color: #FFD700 !important;
  background: transparent !important;
  border: 1px solid rgba(255,215,0,0.5);
}
.nav-pills .nav-link.active, .nav-pills .nav-link:hover {
  background: rgba(255,215,0,0.3) !important;
  color: #fff !important;
}

/* Inputs */
input, textarea, select {
  background: rgba(255,255,255,0.95);
  color: #000;
  border: 1px solid #ccc;
  border-radius: 6px;
}

/* Buttons */
button, .btn {
  background-color: #FFD700 !important;
  color: #3F51B5 !important;
  font-weight: bold;
  border: none;
  border-radius: 6px;
}
button:hover, .btn:hover {
  background-color: #ffeb3b !important;
  color: #2c387e !important;
}

/* Replies and cards */
.alert-light {
  background: rgba(63,81,181,0.2) !important;
  border: 1px solid rgba(255,215,0,0.3) !important;
  color: #FFD700 !important;
}

/* Navbar */
.navbar {
  background-color: #3F51B5 !important;
  box-shadow: 0 2px 10px rgba(0,0,0,0.3);
}
.navbar-brand {
  color: #FFD700 !important;
  font-weight: bold;
}

/* Sidebar links */
.sidebar-link {
  color: #FFD700 !important;
  text-decoration: none;
}
.sidebar-link:hover {
  background: rgba(255,255,255,0.15);
  color: #fff !important;
}

/* Make timestamps and meta info readable */
.time, .reply-time {
  color: #FFD700 !important;
  font-size: 0.85rem;
}
</style>
</head>

<body>
<!-- Sidebar -->
<div class="offcanvas offcanvas-start show" tabindex="-1" id="sidebarMenu" aria-labelledby="sidebarMenuLabel"
 data-bs-backdrop="false" style="background-color:#3F51B5;color:white;width:250px;display:flex;flex-direction:column;height:100vh;">
  
  <div class="offcanvas-header border-bottom border-light">
    <h5 class="offcanvas-title fw-bold" id="sidebarMenuLabel">Menu</h5>
    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas" aria-label="Close"></button>
  </div>

  <div class="offcanvas-body d-flex flex-column justify-content-between" style="flex:1;overflow-y:auto;">
    <div>
      <a href="index7.php" class="sidebar-link mb-2 d-block">üè† Home</a>
      <a href="profile.php" class="sidebar-link mb-2 d-block">üë§ Profile</a>
      <a href="dashboard.php" class="sidebar-link mb-2 d-block">üìä Dashboard</a>
    </div>
    <div class="border-top border-light pt-3 mt-3 text-center">
      <a href="logout.php" class="sidebar-link bg-white text-danger fw-bold px-3 py-2 rounded d-inline-block w-75">üö™ Logout</a>
    </div>
  </div>
</div>

<div class="container py-4 main-wrapper">
  <nav class="navbar navbar-expand-lg navbar-dark">
    <div class="container-fluid">
      <button class="btn btn-light me-3" type="button" data-bs-toggle="offcanvas" data-bs-target="#sidebarMenu">‚ò∞</button>
      <a class="navbar-brand mx-auto text-center" href="#">üó£ Welcome to the Computer Science online Discussion Forum!</a>
    </div>
  </nav>

  <!-- Topics -->
  <ul class="nav nav-pills mb-4">
    <?php foreach ($topics as $topic): ?>
      <li class="nav-item">
        <a class="nav-link <?= $topic === $selectedTopic ? 'active' : '' ?>" href="?topic=<?= urlencode($topic) ?>">
          <?= htmlspecialchars($topic) ?>
        </a>
      </li>
    <?php endforeach; ?>
  </ul>

  <!-- Subscribe -->
  <div class="card mb-4">
    <div class="card-body">
      <h5>üîî Subscribe to Notifications</h5>
      <form method="POST" class="row g-3">
        <div class="col-6">
          <select name="topic" class="form-select" required>
            <option value="">-- Select Topic --</option>
            <?php foreach ($topics as $topic): ?>
              <option value="<?= htmlspecialchars($topic) ?>"><?= htmlspecialchars($topic) ?></option>
            <?php endforeach; ?>
          </select>
        </div>
        <div class="col-6"><input type="email" name="email" class="form-control" placeholder="Enter your email" required></div>
        <div class="col-12"><button type="submit" name="subscribe" class="btn">Subscribe</button></div>
      </form>
      <?= $subscriptionMessage ?? '' ?>
    </div>
  </div>

  <!-- New Discussion -->
  <div class="card mb-4">
    <div class="card-body">
      <h5>Start a New Discussion</h5>
      <form method="POST" class="row g-3">
        <input type="hidden" name="action" value="new_discussion">
        <div class="col-12"><input type="text" name="topic" class="form-control" placeholder="Topic" required></div>
        <div class="col-12"><textarea name="statement" class="form-control" placeholder="Statement" rows="3" required></textarea></div>
        <div class="col-12"><button type="submit" class="btn">Post Discussion</button></div>
      </form>
    </div>
  </div>

  <h4>üßµ Discussions on: <span class="text-light"><?= htmlspecialchars($selectedTopic) ?></span></h4>

  <?php foreach ($discussions as $discussion): ?>
  <div class="card mb-3">
    <div class="card-body">
      <h5><?= htmlspecialchars($discussion['topic']) ?></h5>
      <p><?= nl2br(htmlspecialchars($discussion['statement'])) ?></p>
      <span class="time">Posted at: <?= date('Y-m-d H:i', strtotime($discussion['created_at'] ?? 'now')) ?></span>

      <div class="d-flex justify-content-start gap-4 my-2">
        <form method="POST" class="d-inline">
          <input type="hidden" name="discussion_id" value="<?= $discussion['id'] ?>">
          <input type="hidden" name="action" value="like">
          <button type="submit">‚ù§ <span><?= $discussion['likes'] ?></span></button>
        </form>
        <form method="POST" class="d-inline">
          <input type="hidden" name="discussion_id" value="<?= $discussion['id'] ?>">
          <input type="hidden" name="action" value="retweet">
          <button type="submit">üîÅ <span><?= $discussion['retweets'] ?></span></button>
        </form>
        <button type="button" data-bs-toggle="collapse" data-bs-target="#replyForm<?= $discussion['id'] ?>">üí¨ Reply</button>
      </div>

      <div class="collapse" id="replyForm<?= $discussion['id'] ?>">
        <form method="POST" class="mt-2">
          <input type="hidden" name="discussion_id" value="<?= $discussion['id'] ?>">
          <input type="hidden" name="action" value="reply">
          <div class="input-group">
            <input type="text" name="reply_text" class="form-control" placeholder="Write a reply..." required>
            <button class="btn" type="submit">Reply</button>
          </div>
        </form>
      </div>

      <?php foreach (fetchReplies($pdo, $discussion['id']) as $reply): ?>
      <div class="alert alert-light p-2 my-1">
        <?= htmlspecialchars($reply) ?>
        <div class="text-end time">Just now</div>
      </div>
      <?php endforeach; ?>
    </div>
  </div>
  <?php endforeach; ?>

  <?php if (empty($discussions)): ?>
  <div class="alert alert-warning">No discussions available for this topic yet.</div>
  <?php endif; ?>
</div>
</body>
</html>